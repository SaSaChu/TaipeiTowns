$(function(){function t(t,o){var e=Math.pow(2,o.getZoom()),n=o.getProjection().fromLatLngToPoint(o.getBounds().getNorthEast()),a=o.getProjection().fromLatLngToPoint(o.getBounds().getSouthWest()),l=o.getProjection().fromLatLngToPoint(t);return new google.maps.Point((l.x-a.x)*e,(l.y-n.y)*e)}function o(){u.length>2&&(k||(k=new google.maps.Polygon({map:d,strokeColor:"rgba(252, 30, 112, 1)",strokeOpacity:0,strokeWeight:0,fillColor:"rgba(252, 30, 112, 1)",fillOpacity:.55,draggable:!1,geodesic:!1})),k.setPath(u.map(function(t){return t.position})));for(var o=0;o<u.length;o++){if(!u[o].polyline){var e=new google.maps.Polyline({map:d,strokeColor:"rgba(120, 0, 0, 1)",strokeWeight:3,drawPath:function(){var t=this.prevMarker.getPosition(),o=this.nextMarker.getPosition();this.setPath([t,o]),this.prevMarker.map||this.prevMarker.setMap(d),this.nextMarker.map||this.nextMarker.setMap(d),this.map||this.setMap(d)}});google.maps.event.addListener(e,"rightclick",function(o){var n=t(o.latLng,d);c.css({top:n.y,left:n.x}).data("lat",o.latLng.lat()).data("lng",o.latLng.lng()).addClass("show").polyline=e}),u[o].polyline=e}u[o].polyline.prevMarker=u[o-1]?u[o-1]:u[u.length-1],u[o].polyline.nextMarker=u[o],u[o].polyline.drawPath()}u.length?f.show():f.hide()}function e(t){return"M 0 0 m -"+t+", 0 a "+t+","+t+" 0 1,0 "+2*t+",0 a "+t+","+t+" 0 1,0 -"+2*t+",0"}function n(t,n){var a=new google.maps.Marker({map:d,draggable:!0,position:t,icon:{path:e(5),strokeColor:"rgba(120, 0, 0, .75)",strokeWeight:1,fillColor:"rgba(255, 0, 0, .75)",fillOpacity:1},getPixelPosition:y});google.maps.event.addListener(a,"drag",o),google.maps.event.addListener(a,"rightclick",function(){var t=a.getPixelPosition();p.css({top:t.y,left:t.x}).addClass("show").marker=a}),u.splice(n?n:u.length,0,a),o()}function a(t){$.getJSON("towns/"+t+".json",function(t){var o=new google.maps.LatLngBounds;t.forEach(function(t,e){var a=new google.maps.LatLng(t[0],t[1]);o.extend(a),n(a,e)}),d.fitBounds(o)})}function l(t,o){$.getJSON("towns/"+t+".json",function(e){var n=e.map(function(t){return new google.maps.LatLng(t[0],t[1])}),a=new google.maps.Polygon({path:n,map:d,fillColor:o?"rgba(0, 0, 255, 1)":"rgba(0, 86, 0, 1)",fillOpacity:.35,strokeColor:o?"rgba(0, 0, 255, 1)":"rgba(0, 86, 0, 1)",strokeWeight:.65});a.key=t,a.addListener("click",function(){m.val(this.key).change()}),v.push(a),v.length==L.concat(w).length&&m.change()})}function i(){h.addClass("hide").fadeOut(function(){$(this).hide(function(){h.remove()})})}function s(){d=new google.maps.Map(r.get(0),{zoom:11,zoomControl:!0,scrollwheel:!0,scaleControl:!0,mapTypeControl:!1,navigationControl:!0,streetViewControl:!1,disableDoubleClickZoom:!0,center:new google.maps.LatLng(25.054,121.54)}),google.maps.event.addListener(d,"rightclick",function(t){g.css({top:t.pixel.y,left:t.pixel.x}).data("lat",t.latLng.lat()).data("lng",t.latLng.lng()).addClass("show")}),google.maps.event.addListener(d,"mousemove",function(){g.css({top:-100,left:-100}).removeClass("show"),p.css({top:-100,left:-100}).removeClass("show"),c.css({top:-100,left:-100}).removeClass("show")}),g.find(".add_marker").click(function(){n(new google.maps.LatLng(g.data("lat"),g.data("lng")),0),g.css({top:-100,left:-100}).removeClass("show")}),g.find(".add_info").click(function(){initInfo(new google.maps.LatLng(g.data("lat"),g.data("lng"))),g.css({top:-100,left:-100}).removeClass("show")}),p.find(".del").click(function(){u.splice(u.indexOf(p.marker),1),p.marker.setMap(null),p.marker.polyline&&p.marker.polyline.setMap(null),o(),p.css({top:-100,left:-100}).removeClass("show")}),c.find(".add").click(function(){c.polyline&&n(new google.maps.LatLng(c.data("lat"),c.data("lng")),u.indexOf(c.polyline.nextMarker)),c.css({top:-100,left:-100}).removeClass("show")}),f.hide().click(function(){saveAs(new Blob(["[\n"+u.map(function(t){return"  ["+t.position.lat()+", "+t.position.lng()+"]"}).join(",  \n")+"\n]"],{type:"text/plain;charset=utf-8"}),m.val()+".json")}),m.append($("<optgroup />").attr("label","台北市").append(L.map(function(t){return $("<option />").val(t).text(t)}))).append($("<optgroup />").attr("label","新北市").append(w.map(function(t){return $("<option />").val(t).text(t)}))),m.change(function(){var t=$(this).val();u.forEach(function(t){t.setMap(null),t.polyline.setMap(null)}),u=[],v.forEach(function(t){t.map||t.setMap(d)}),v.forEach(function(o){o.key==t&&o.setMap(null)}),v.forEach(function(o){o.key==t&&a(t)})}),L.forEach(function(t){l(t,1)}),w.forEach(function(t){l(t,0)}),i()}var r=$("#map"),g=$("#map_menu"),p=$("#marker_menu"),c=$("#polyline_menu"),f=$("#export"),m=$("#select"),h=$("#loading"),d=null,u=[],k=null,v=[],L=["中山區","中正區","信義區","內湖區","北投區","南港區","士林區","大同區","大安區","文山區","松山區","萬華區"],w=["三峽區","三芝區","三重區","中和區","五股區","八里區","土城區","坪林區","平溪區","新店區","新莊區","板橋區","林口區","樹林區","永和區","汐止區","泰山區","淡水區","深坑區","烏來區","瑞芳區","石碇區","石門區","萬里區","蘆洲區","貢寮區","金山區","雙溪區","鶯歌區"],y=function(){var t=Math.pow(2,this.map.getZoom()),o=new google.maps.LatLng(this.map.getBounds().getNorthEast().lat(),this.map.getBounds().getSouthWest().lng()),e=this.map.getProjection().fromLatLngToPoint(o),n=this.map.getProjection().fromLatLngToPoint(this.getPosition());return new google.maps.Point((n.x-e.x)*t,(n.y-e.y)*t)};google.maps.event.addDomListener(window,"load",s)});